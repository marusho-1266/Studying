### DKIM (DomainKeys Identified Mail) とは

DKIM (DomainKeys Identified Mail) は、**電子メールの送信元認証**と**メッセージの改ざん検知**を目的とした認証技術です。SPFが「メールが正規のサーバーから送られたか」を検証するのに対し、DKIMは「**メールが正規のドメインによって署名され、かつ途中で改ざんされていないか**」を検証します。

#### DKIMの目的

電子メールの偽装や改ざんは、スパム、フィッシング詐欺、ビジネスメール詐欺（BEC）などのサイバー犯罪において頻繁に用いられる手口です。DKIMは、以下の目的のために開発されました。

- **送信元ドメインの保証:** 送信メールが、実際にそのドメインの所有者によって送信されたものであることを証明します。これにより、Fromヘッダー（ユーザーがメールクライアントで確認する送信元アドレス）の詐称を防ぎます。
    
- **メッセージの完全性保証:** 送信されてから受信されるまでの間に、メールの内容（本文や特定のヘッダー情報）が第三者によって改ざんされていないことを確認します。
    

#### DKIMの仕組み

DKIMは、公開鍵暗号方式を利用したデジタル署名の仕組みに基づいています。

1. **送信側での処理:**
    
    - **秘密鍵の生成:** メールを送信するドメインの管理者は、秘密鍵と公開鍵のペアを生成します。秘密鍵は送信側のメールサーバー内に厳重に保管されます。
        
    - **DKIM-Signatureヘッダーの生成と付与:**
        
        - 送信メールサーバーは、メールの特定のヘッダー（`From`、`To`、`Subject`など）と本文の一部または全体をハッシュ化します。
            
        - このハッシュ値を、保管している**秘密鍵**で暗号化し、デジタル署名を生成します。
            
        - 生成されたデジタル署名と、署名に使用したアルゴリズム、署名範囲、公開鍵のセレクタ（後述）などの情報を含む`DKIM-Signature`ヘッダーをメールに追加します。
            
    
    **`DKIM-Signature`ヘッダーの例:**
    
    ```
    DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=example.com; s=s12345;
     h=from:to:subject:date; bh=...; b=...
    ```
    
    - `d=example.com`: 署名したドメイン（例: example.com）
        
    - `s=s12345`: セレクタ（公開鍵を一意に識別するための文字列。DNSレコード名の一部になる）
        
    - `h=from:to:subject:date`: 署名の対象となったヘッダーフィールド
        
    - `bh=...`: メール本文のハッシュ値
        
    - `b=...`: デジタル署名（秘密鍵で暗号化されたハッシュ値）
        
2. **DNS (Domain Name System) レコード**
    
    - 送信ドメインの管理者は、生成した**公開鍵**を自身のドメインのDNSに**TXTレコード**として公開します。公開鍵のDNSレコード名には、`s` パラメータで指定されたセレクタが含まれます。
        
    - 例: `s12345._domainkey.example.com` に公開鍵のTXTレコードが登録されます。
        
3. **受信側での検証:**
    
    - メールを受信したメールサーバーは、`DKIM-Signature`ヘッダーを検出します。
        
    - ヘッダーから**署名ドメイン** (`d` パラメータ) と**セレクタ** (`s` パラメータ) を抽出し、これらを使ってDNSから対応する**公開鍵**を取得します（例: `s12345._domainkey.example.com` のTXTレコードを検索）。
        
    - 取得した公開鍵と、`DKIM-Signature`ヘッダーに記載されたデジタル署名 (`b` パラメータ) を用いて、メールのハッシュ値を復号します。
        
    - 受信したメールの同じヘッダーと本文を再度ハッシュ化し、その値と復号したハッシュ値を比較します。
        
    - **検証結果:**
        
        - 両方のハッシュ値が一致すれば、メールは正当なドメインによって署名され、かつ改ざんされていないと判断されます（**Pass**）。
            
        - 一致しない場合は、署名が不正であるか、メールが改ざんされたと判断されます（**Fail**）。
            
        - 公開鍵が見つからない、形式が不正などの場合はエラーとなります。
            

#### DKIMの利点

- **Fromヘッダーの保護:** SPFがエンベロープFromアドレスを保護するのに対し、DKIMはユーザーが目にする`From:`ヘッダーを含むメール内容全体を保護します。これにより、フィッシング詐欺で多用される「表示上の送信元詐称」を防ぐのに役立ちます。
    
- **メッセージの完全性:** メールが途中で改ざんされていないことを確認できるため、信頼性が向上します。
    
- **転送メールへの対応:** メールが転送されても、その内容が改ざんされなければ、DKIM署名は有効性を保ちます。これはSPFが苦手とする点です。
    
- **ドメインの評判向上:** DKIMを導入することで、自ドメインから送信されるメールの信頼性が高まり、迷惑メールと判断されるリスクを低減できます。
    

#### SPFとDKIMの関係、およびDMARC

DKIMは単独でも機能しますが、SPFと組み合わせて使用することで、より強固なメール認証を実現できます。

さらに、これらの認証結果に基づいて、受信側がどのようにメールを処理すべきかを送信側が指示するためのポリシーを定義する技術としてDMARC (Domain-based Message Authentication, Reporting & Conformance) があります。DMARCは、SPFとDKIMの両方の検証結果を集約し、認証に失敗したメールを「拒否する」「隔離する（迷惑メールフォルダへ）」「何もしない（レポートのみ）」といった指示を受信サーバーに与えることができます。

---
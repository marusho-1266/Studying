ICMP（Internet Control Message Protocol）は、IP（Internet Protocol）と同じくインターネット層（OSI参照モデルの第3層）で動作するプロトコルで、主に**IPネットワーク上でのエラー報告や運用診断**のために使用されます。

IPプロトコルはデータを送ることに特化しており、パケットが正しく届いたか、途中でエラーが発生したかといった信頼性やエラー処理の機能は持っていません。その不足を補うのがICMPの役割です。

### ICMPの主な役割と機能

ICMPは、データ転送そのものではなく、ネットワークの状態やエラーに関する「制御メッセージ」をやり取りするために使われます。

1. エラー報告:
    
    IPパケットの転送中に問題が発生した場合、そのエラーを元の送信元に通知します。
    
    - 宛先到達不能 (Destination Unreachable):
        
        指定された宛先IPアドレスに到達できない場合（例：ホストが存在しない、ポートが閉じているなど）に送信されます。
        
    - 時間切れ (Time Exceeded):
        
        パケットがルーターを通過できるホップ数（TTL: Time To Live）の上限を超過した場合（ループなどでパケットが無限に転送されるのを防ぐため）に送信されます。
        
    - パラメータ問題 (Parameter Problem):
        
        IPヘッダに不正な値やオプションが含まれている場合に送信されます。
        
    - リダイレクト (Redirect):
        
        ルーターが、より効率的なルーティング経路があることを送信元に通知するために使用します。
        
2. 運用診断（クエリ）:
    
    ネットワークの状態を確認したり、診断したりするための問い合わせと応答のメッセージを定義します。
    
    - エコー要求/応答 (Echo Request/Reply):
        
        最もよく知られている機能で、「Ping」コマンドで使用されます。
        
        - **エコー要求 (Echo Request):** 特定のホストが稼働しているか、ネットワーク接続が可能かを確認するために送信されます。
            
        - **エコー応答 (Echo Reply):** エコー要求を受信したホストが、それに対する返答として送信します。これにより、対象ホストの応答性やネットワークの遅延を測定できます。
            
    - タイムスタンプ要求/応答 (Timestamp Request/Reply):
        
        送信元と宛先間の時間遅延を測定するために使用されます。
        
    - 情報要求/応答 (Information Request/Reply):
        
        （現在はほとんど使われない）ホストがネットワークアドレスを学習するために使用されました。
        

### ICMPメッセージの構造

ICMPメッセージは、IPヘッダの直後にカプセル化されて送信されます。

メッセージ自体は、**タイプ（Type）とコード（Code）**というフィールドを持っており、これらによってメッセージの種類と具体的な内容が識別されます。

- **Type:** ICMPメッセージの一般的なカテゴリ（例：エコー要求、宛先到達不能など）を定義します。
    
- **Code:** Typeの具体的なサブカテゴリや詳細な理由を定義します。
    

### ICMPの利用例

- **Pingコマンド:** `ping example.com` のようにコマンドを入力すると、ICMPエコー要求パケットが送信され、その応答によって対象ホストの疎通確認や応答時間測定が行われます。
    
- **Traceroute/Tracertコマンド:** ネットワーク上のルーターの経路を追跡するためにICMPの「時間切れ」メッセージを利用します。
    
- **ネットワーク監視ツール:** ICMPを利用して、ネットワーク上のデバイスの死活監視を行います。
    

### ICMPとセキュリティ

ICMPはネットワークの診断や運用に非常に役立つ一方で、悪用されるとセキュリティ上の問題を引き起こす可能性があります。

- **[[Smurf攻撃]]:** ICMPエコー要求を悪用したDDoS攻撃。
    
- **ICMPフラッド:** 大量のICMPパケットを送りつけることで、ネットワーク帯域やCPUリソースを消費させるDDoS攻撃。
    
- **情報収集:** ICMPのエラーメッセージや応答から、ネットワークのトポロジー、OSの種類、ファイアウォールの設定などに関する情報が漏洩する可能性があります。
    
- **ファイアウォール回避:** 悪意のあるトラフィックをICMPエラーメッセージに見せかけて送信しようとする試み。
    

このため、セキュリティ対策として、ファイアウォールなどで不要なICMPメッセージをフィルタリングしたり、レートリミット（一定時間あたりのパケット数を制限）を適用したりすることが推奨されます。特に、外部からのICMPエコー要求への応答を制限する設定は一般的です。
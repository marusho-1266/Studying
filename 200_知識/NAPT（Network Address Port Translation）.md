NAPT（Network Address Port Translation：ネットワークアドレスポート変換）は、**IPアドレスだけでなく、ポート番号も変換することで、たった一つのグローバルIPアドレスを複数のプライベートIPアドレスを持つデバイスで共有し、同時にインターネットに接続できるようにする技術**です。

日本では「IPマスカレード」と呼ばれることも多く、また「PAT（Port Address Translation）」とも呼ばれます。現在の家庭用ルーターや多くの企業ネットワークで一般的に使われているNATは、ほとんどがこのNAPTの機能を含んでいます。

### NAPTの仕組み

NAPTの動作は、基本的にNATの仕組みを拡張したものです。ルーターなどのNAPT対応デバイスが、内部ネットワーク（プライベートIPアドレス空間）から外部ネットワーク（グローバルIPアドレス空間、インターネットなど）への通信を中継する際に、以下の変換を行います。

1. **内部から外部への通信（送信時）**：
    
    - **変換前**: 内部のデバイス（例: 192.168.1.10:ポート番号12345）が、外部のWebサーバー（例: 203.0.113.1:ポート番号80）にアクセスしようとします。
        
    - **NAPTによる変換**: NAPTルーターは、パケットの送信元IPアドレス（192.168.1.10）を、ルーター自身のグローバルIPアドレス（例: 203.0.113.200）に変換します。
        
    - **ポート番号の変換**: 同時に、送信元ポート番号（12345）も、ルーターが未使用のユニークなポート番号（例: 50001）に変換します。
        
    - **変換テーブルへの記録**: NAPTルーターは、「内部IP:ポート」と「グローバルIP:変換後ポート」の対応関係を内部の変換テーブル（NATテーブル）に記録します。（例: `192.168.1.10:12345 <-> 203.0.113.200:50001`）
        
    - **パケットの転送**: 変換されたパケット（送信元: 203.0.113.200:50001、宛先: 203.0.113.1:80）が外部に送信されます。
        
2. **外部から内部への応答通信（受信時）**：
    
    - **応答パケットの受信**: Webサーバーから、ルーターのグローバルIPアドレスと変換後のポート番号宛に応答パケット（送信元: 203.0.113.1:80、宛先: 203.0.113.200:50001）が返ってきます。
        
    - **NAPTによる逆変換**: NAPTルーターは、受信したパケットの宛先IPアドレスとポート番号を変換テーブルと照合します。
        
    - **適切なデバイスへの転送**: テーブルから対応する内部IPアドレスとポート番号（192.168.1.10:12345）を見つけ出し、パケットの宛先を元のプライベートIPアドレスとポート番号に変換し、該当するデバイスに転送します。
        

**ポイントは「ポート番号」**です。同じグローバルIPアドレスを共有していても、それぞれの通信には異なる送信元ポート番号が割り当てられるため、ルーターはどの内部デバイスからの通信に対する応答なのかを正確に判別できます。

### NAPTのメリット

- **IPv4アドレスの劇的な節約**: これがNAPTの最大のメリットです。限られたグローバルIPアドレスを、数十、数百、数千といった多数の内部デバイスで共有できるようになります。IPv4アドレス枯渇問題の緩和に大きく貢献しました。
    
- **セキュリティの向上（副次的効果）**: 外部から見ると、すべての内部デバイスが単一のグローバルIPアドレスの背後に隠れているように見えます。NAPTルーターは、内部から開始された通信の応答以外は、外部からの不意な接続要求を基本的に破棄するため、内部ネットワークが直接外部にさらされるリスクが低減します。これは一種の簡易的なファイアウォールとして機能します。
    
- **ネットワーク構成の柔軟性**: 内部ネットワークのIPアドレス設計がプライベートアドレス空間内で自由に行えるため、柔軟なネットワーク構築が可能です。
    

### NAPTのデメリット・課題

- **一部アプリケーションの不具合**:
    
    - **P2P通信やオンラインゲーム**: IPアドレスやポート番号が動的に変換されるため、相手側から直接接続を開始する必要があるP2Pアプリケーションや一部のオンラインゲームで通信が確立しにくい場合があります。この場合、「ポートフォワーディング（ポート開放）」や「UPnP」といった機能で特定のポートを内部デバイスに転送する設定が必要になります。
        
    - **IPアドレス埋め込みプロトコル**: FTPのアクティブモードなど、データ部の中にIPアドレス情報が埋め込まれているプロトコルでは、NAPTによるIPアドレス変換が原因で通信が正常に行われないことがあります。この問題に対処するためには、アプリケーションレベルゲートウェイ（ALG）などの特別な処理が必要になる場合があります。
        
- **通信の追跡の困難化**: NAPTによってIPアドレスとポート番号が変換されるため、通信ログなどを解析する際に、元の内部デバイスを特定するのが難しくなることがあります。セキュリティインシデントの調査などで問題になることがあります。
    
- **パフォーマンスへの影響**: パケットがルーターを通過する際に変換処理が行われるため、わずかながら処理負荷と遅延が発生します。
    
- **IPv6との関連**: IPv6ではIPアドレスの数が膨大であるため、IPv4のようなアドレス枯渇問題は発生せず、各デバイスに[[グローバルユニキャストアドレス]]を直接割り当てることが可能です。そのため、IPv6ではNAPTのようなアドレス変換は基本的に不要となります。
    

NAPTは、今日のインターネット環境を支える非常に重要な技術であり、私たちの日常生活で不可用なインターネット接続を可能にしています。
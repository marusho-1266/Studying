### SPF (Sender Policy Framework) とは

SPF (Sender Policy Framework) は、**電子メールの送信元詐称（なりすまし）を防ぐための認証技術**の一つです。特に、メールの**エンベロープFromアドレス**（SMTP通信の `MAIL FROM` コマンドで指定される送信元アドレス）のドメインが、正規のメールサーバーから送信されたものであるかを検証します。

#### SPFの目的

インターネット上の電子メールは、ヘッダーに記載された送信元アドレス（`From:` ヘッダーなど）を比較的容易に詐称できてしまいます。これにより、スパムメールやフィッシング詐欺メールが、あたかも正規の組織や個人から送られてきたかのように見せかけることが可能になり、受信者をだます手口として悪用されてきました。

SPFは、このような送信元詐称を防ぎ、**受信者がメールの正当性を確認できる手段を提供すること**を目的としています。

#### SPFの仕組み

SPFは、主に以下の2つの要素と連携して機能します。

1. DNS (Domain Name System) レコード
    
    メールを送信する側のドメイン管理者は、自身のドメインのDNSにSPFレコード（TXTレコードの一種）を公開します。このSPFレコードには、そのドメインからのメール送信を許可するメールサーバーのIPアドレスやホスト名が記述されています。
    
    SPFレコードの例:
    
    v=spf1 ip4:192.0.2.1 include:_spf.google.com ~all
    
    - `v=spf1`: SPFのバージョンを示します。
        
    - `ip4:192.0.2.1`: このIPアドレスからの送信を許可します。
        
    - `include:_spf.google.com`: GoogleのSPFレコードを参照し、そこに定義されたサーバーからの送信も許可します（委譲）。
        
    - `~all`: 上記に明示的に許可されていない他のすべてのIPアドレスからのメールは「SoftFail」（疑わしいが拒否まではしない）と判断します。他にも `-all`（HardFail: 拒否）、`+all`（常にPass: 非推奨）などがあります。
        
2. 受信側のメールサーバー
    
    メールを受信する側のメールサーバーは、以下の手順でSPF検証を行います。
    
    1. 受信したメールの**エンベロープFromアドレス**（SMTP通信の `MAIL FROM` コマンドで指定されたドメイン）を取得します。
        
    2. そのドメインのDNSに公開されている**SPFレコード**を検索・取得します。
        
    3. 実際にメールを送信してきた**送信元メールサーバーのIPアドレス**が、取得したSPFレコードに記載されている「送信を許可されたIPアドレス」のリストに含まれているかを確認します。
        
    4. 検証結果に基づいて、メールの処理を決定します。
        
        - **Pass (合格):** 送信元IPアドレスが許可されたリストに含まれる場合。メールは正当と判断されます。
            
        - **Fail (不合格):** 送信元IPアドレスが許可されたリストに含まれない、かつ `-all` が指定されている場合。メールは詐称の可能性が高いと判断され、拒否されるか、迷惑メールとして処理されます。
            
        - **SoftFail (準不合格):** 送信元IPアドレスが許可されたリストに含まれないが、`~all` が指定されている場合。疑わしいが、直ちに拒否はしないという判断になります。
            
        - **Neutral (中立):** 明示的な許可も拒否もされていない場合。
            
        - **None (なし):** ドメインにSPFレコードが公開されていない場合。
            
        - **TempError/PermError (エラー):** DNSクエリなどのエラー。
            

#### SPFの利点と限界

**利点:**

- **送信元詐称対策:** 最も基本的なメール認証であり、なりすましメールのブロックに効果的です。
    
- **設定の容易さ:** DNSレコードを追加するだけで導入でき、比較的容易です。
    
- **スパム対策:** SPFを導入することで、自ドメインがスパムメールの送信元として悪用されることを防ぎ、ドメインの評判を保護できます。
    

**限界:**

- **転送メールの問題:** メールが転送されると、転送元サーバーのIPアドレスと最初の送信元ドメインのSPFレコードが不一致になり、`Fail` と判定されることがあります（これは主にDMARCで解決が図られます）。
    
- **Fromヘッダーの保護なし:** SPFはエンベロープFromアドレスを保護しますが、ユーザーが目にする `From:` ヘッダーのアドレスは保護しません。これは、エンベロープFromアドレスとヘッダーFromアドレスが異なる場合があるためです。
    
- **デジタル署名ではない:** メール内容の改ざん検知や、送信者の署名検証は行いません。これはDKIMやS/MIMEの役割です。
    

#### まとめ

SPFは、メールの送信元IPアドレスがそのドメインの正当な送信元であるかを検証することで、送信元詐称によるなりすましメールを効果的に防ぐための重要な技術です。DKIM (DomainKeys Identified Mail) やDMARC (Domain-based Message Authentication, Reporting & Conformance) と組み合わせて使用することで、より堅牢なメール認証を実現し、フィッシング詐欺やスパムからの保護を強化することができます。